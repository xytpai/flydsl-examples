# flydsl: pre_v0.1

import numpy as np
import flydsl.compiler as flyc
import flydsl.expr as fx
from flydsl.compiler.kernel_function import CompilationContext
from flydsl.expr import range_constexpr
from flydsl.runtime.device import get_rocm_arch
from flydsl.utils.smem_allocator import SmemAllocator, SmemPtr
from flydsl._mlir import ir
from flydsl.expr import arith, vector
from flydsl.expr import gpu
from flydsl.expr import buffer_ops, rocdl
from flydsl.expr.arith import _to_raw as _raw
from flydsl.expr.typing import T
from flydsl.compiler import from_dlpack


class GTensor:
    def __init__(self, fx_tensor, dtype, shape, stride=None, vec_size=1):
        self.fx_tensor = fx_tensor
        self.dtype = dtype
        self.shape = shape
        if stride is None:
            self.stride = tuple((np.cumprod(shape[::-1])[::-1].tolist()+[1,])[1:])
        else:
            self.stride = stride
        self.vec_size = vec_size
        self.rsrc = buffer_ops.create_buffer_resource(fx_tensor, max_size=True)

    def __getitem__(self, idxs):
        offset = 0
        for i in range_constexpr(len(idxs)):
            offset = offset + idxs[i] * self.stride[i]
        return buffer_ops.buffer_load(self.rsrc, offset, vec_width=self.vec_size, dtype=self.dtype)

    def __setitem__(self, frag, idxs):
        offset = 0
        for i in range_constexpr(len(idxs)):
            offset = offset + idxs[i] * self.stride[i]
        buffer_ops.buffer_store(frag, self.rsrc, offset, offset_is_bytes=False)


class STensor:
    def __init__(self, fx_tensor, dtype, shape, stride=None):
        self.fx_tensor = fx_tensor
        self.dtype = dtype
        self.shape = shape
        if stride is None:
            self.stride = tuple((np.cumprod(shape[::-1])[::-1].tolist()+[1,])[1:])
        else:
            self.stride = stride

    def __getitem__(self, idxs):
        offset = 0
        for i in range_constexpr(len(idxs)):
            offset = offset + idxs[i] * self.stride[i]
        return self.fx_tensor.load([arith.as_value(offset)])

    def __setitem__(self, frag, idxs):
        offset = 0
        for i in range_constexpr(len(idxs)):
            offset = offset + idxs[i] * self.stride[i]
        self.fx_tensor.store([arith.as_value(offset)])
